  %% draftinputlines.sty
  %% Copyright 2011 Seamus Bradley
  %
  % This work may be distributed and/or modified under the
  % conditions of the LaTeX Project Public License, either version 1.3
  % of this license or (at your option) any later version.
  % The latest version of this license is in
  %   http://www.latex-project.org/lppl.txt
  % and version 1.3 or later is part of all distributions of LaTeX
  % version 2005/12/01 or later.
  %
  % This work has the LPPL maintenance status `maintained'.
  % 
  % The Current Maintainer of this work is Seamus Bradley
  % tex@seamusbradley.net
  %
  % This work consists of the file draftinputlines.sty
  % and README

\ProvidesPackage{draftinputlines}[2011/07/16 v0.4]


%------------------------------
% Important packages
%------------------------------

\RequirePackage{currfile} % Loads filehook, which I also use...
\RequirePackage{etoolbox}
\RequirePackage{xkeyval}

%------------------------------
% New things
%------------------------------

\newcounter{firstline}
\newif\ifdil@scrpage
\newif\ifdil@fancyhdr
\newif\ifdil@memoir
\newif\ifdil@plain

\define@choicekey{dilfamily}{headfootpackage}[\val\nr]{%
  scrpage,fancyhdr,memoir,plain}{%
  \ifcase\nr\relax
  \dil@scrpagetrue\or
  \dil@fancyhdrtrue\or
  \dil@memoirtrue\or
  \dil@plaintrue\or
  \relax
  \fi
%--------------------------------------------------
% Headers and footers
%--------------------------------------------------

%------------------------------
% Use KOMA's scrpage2
%------------------------------



\setkeys{dilfamily}{scrpage=true}
\ifKV@dilfamily@scrpage
\RequirePackage{scrpage2}
\pagestyle{scrheadings}

\def\dil@insidehead{
  \ihead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@outsidehead{
  \ohead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@centerhead{
  \chead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@lefthead{
  \lohead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
  \lehead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@righthead{
  \rohead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
  \rehead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}


\def\dil@insidefoot{
    \ifoot{\texttt{\the\inputlineno}}
}
\def\dil@outsidefoot{
    \ofoot{\texttt{\the\inputlineno}}
}
\def\dil@centerfoot{
    \cfoot{\texttt{\the\inputlineno}}
}
\def\dil@leftfoot{
    \lofoot{\texttt{\the\inputlineno}}
    \lefoot{\texttt{\the\inputlineno}}
}
\def\dil@rightfoot{
    \rofoot{\texttt{\the\inputlineno}}
    \refoot{\texttt{\the\inputlineno}}
}
\fi

%------------------------------
% The actual keys
%------------------------------

\define@choicekey{dilfamily}{inputlineshead}[\val\nr]{%
  inside,outside,center,left,right,off}{%
  \ifcase\nr\relax
  \dil@insidehead
  \or
  \dil@outsidehead
  \or
  \dil@centerhead
  \or
  \dil@lefthead
  \or
  \dil@righthead
  \or
  \relax
  \fi
}

\define@choicekey{dilfamily}{inputlinesfoot}[\val\nr]{%
  inside,outside,center,left,right,off}{%
  \ifcase\nr\relax
  \dil@insidefoot
  \or
  \dil@outsidefoot
  \or
  \dil@centerfoot
  \or
  \dil@leftfoot
  \or
  \dil@rightfoot
  \or
  \relax
  \fi
}




\newcommand\setupinputlines[1]{%
  \setkeys{dilfamily}{#1}
}


% Package option for user coloured linenumbers?
\RequirePackage{xcolor}
\newcommand\useraddlineno{\marginpar{\textcolor{red}{\the\inputlineno}}}

% Package option that loads showkeys?
\RequirePackage{showkeys}


% Here comes the meat of the functionality
\newcommand\addlineno{\marginpar{\texttt{\the\inputlineno}}}

\pretocmd{\@startsection}{\addlineno}{}{}

\apptocmd{\caption}{{\ttfamily\the\inputlineno\quad}}{}{}

\newcommand\patchenv[1]{%
  \AtBeginEnvironment{#1}{\addlineno}}
\newcommand\csvpatchenv{%
  \let\do\patchenv
  \docsvlist}
% Add environments to the list to have them print a line number.
\csvpatchenv{itemize,enumerate,description,quote}

% Optional lists of environments
% mathmode
% amsmath
% amsthm
% ntheorem's named envs?

\AtBeginDocument{\setcounter{firstline}{\the\inputlineno}}
\AtBeginOfInputs{\marginpar{\texttt{\currfilename}}}
\AtBeginOfIncludes{\marginpar{\texttt{\currfilename}}}
