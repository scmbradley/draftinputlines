  %% draftinputlines.sty
  %% Copyright 2011 Seamus Bradley
  %
  % This work may be distributed and/or modified under the
  % conditions of the LaTeX Project Public License, either version 1.3
  % of this license or (at your option) any later version.
  % The latest version of this license is in
  %   http://www.latex-project.org/lppl.txt
  % and version 1.3 or later is part of all distributions of LaTeX
  % version 2005/12/01 or later.
  %
  % This work has the LPPL maintenance status `maintained'.
  % 
  % The Current Maintainer of this work is Seamus Bradley
  % tex@seamusbradley.net
  %
  % This work consists of the file draftinputlines.sty,
  % draftinputlines-man.tex and README;
  % and derived file draftinputlines-man.pdf

\ProvidesPackage{draftinputlines}[2011/07/17 v0.41]


%------------------------------
% Important packages
%------------------------------

\RequirePackage{currfile} % Loads filehook, which I also use...
\RequirePackage{etoolbox}
\RequirePackage{xkeyval}
\RequirePackage{marginnote}
%------------------------------
% New things
%------------------------------

\newcounter{firstline}
\newcommand\dilmnote[1]{\marginpar{\raggedright\small #1}}
\newcommand\dilmnotefloat[1]{\marginnote{\raggedright\small #1}}

%--------------------------------------------------
% Headers and footers
%--------------------------------------------------

\define@boolkeys{dilfamily}{scrpage,fancyhdr,memoir,plain}{}

%------------------------------
% Define some empty macros
%------------------------------
  \def\dil@insidehead{}
  \def\dil@outsidehead{}
  \def\dil@centerhead{}
  \def\dil@lefthead{}
  \def\dil@righthead{}
  \def\dil@insidefoot{}
  \def\dil@outsidefoot{}
  \def\dil@centerfoot{}
  \def\dil@leftfoot{}
  \def\dil@rightfoot{}

%------------------------------
% Setup headers and footers
%------------------------------

\define@choicekey{dilfamily}{headfootpackage}{%
  scrpage,fancyhdr,memoir,plain}{%
  \setkeys{dilfamily}{#1=true}
}

%------------------------------
% The actual keys
%------------------------------

\define@choicekey{dilfamily}{inputlineshead}[\val\nr]{%
  inside,outside,center,left,right,off}{%
  \AtEndPreamble{
    \ifcase\nr\relax
    \dil@insidehead
    \or
    \dil@outsidehead
    \or
    \dil@centerhead
    \or
    \dil@lefthead
    \or
    \dil@righthead
    \or
    \relax
    \fi
  }
}

\define@choicekey{dilfamily}{inputlinesfoot}[\val\nr]{%
  inside,outside,center,left,right,off}{%
  \AtEndPreamble{
    \ifcase\nr\relax
    \dil@insidefoot
    \or
    \dil@outsidefoot
    \or
    \dil@centerfoot
    \or
    \dil@leftfoot
    \or
    \dil@rightfoot
    \or
    \relax
    \fi
  }
}

\newcommand\setupinputlines[1]{%
  \setkeys{dilfamily}{#1}
}


% Package option for user coloured linenumbers?
\RequirePackage{xcolor}
\newcommand\useraddlineno{\dilmnote{\textcolor{red}{\the\inputlineno}}}

% % Package option that loads showkeys?
% \RequirePackage{showkeys}

% Here comes the meat of the functionality
\newcommand\addlineno{\dilmnote{\texttt{\the\inputlineno}}}

\define@boolkey{dilfamily}{sectionline}[true]{}
\define@boolkey{dilfamily}{captionline}[true]{}



\newcommand\dil@patchenv[1]{%
  \AtBeginEnvironment{#1}{\addlineno}}
\newcommand\dil@csvpatchenv{%
  \let\do\dil@patchenv
  \docsvlist}
% Add environments to the list to have them print a line number.
%\dil@csvpatchenv{itemize,enumerate,description,quote}


\define@key{dilfamily}{environmentline}{\dil@csvpatchenv{#1}}
\define@boolkey{dilfamily}{dilbasicenvlines}[true]{}
\define@boolkey{dilfamily}{dilamsmathenvlines}[true]{}
\define@boolkey{dilfamily}{dilinputfiles}[true]{}
\define@boolkey{dilfamily}{inputfilesrule}[true]{}

% Optional lists of environments
% mathmode
% amsmath
% amsthm
% ntheorem's named envs?


%------------------------------
% Default options
%------------------------------

\setkeys{dilfamily}{
  sectionline=true,
  captionline=true,
  inputlineshead=outside,
  inputlinesfoot=outside,
  dilinputfiles=true,
}

\ProcessOptionsX<dilfamily>

%------------------------------
% Headers and footers
%------------------------------
% Define commands for scrpage
\ifKV@dilfamily@scrpage
\RequirePackage{scrpage2}
\pagestyle{scrheadings}
\def\dil@insidehead{
  \ihead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@outsidehead{
  \ohead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@centerhead{
  \chead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@lefthead{
  \lohead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
  \lehead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@righthead{
  \rohead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
  \rehead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@insidefoot{
  \ifoot{\texttt{\the\inputlineno}}
}
\def\dil@outsidefoot{
  \ofoot{\texttt{\the\inputlineno}}
}
\def\dil@centerfoot{
  \cfoot{\texttt{\the\inputlineno}}
}
\def\dil@leftfoot{
  \lofoot{\texttt{\the\inputlineno}}
  \lefoot{\texttt{\the\inputlineno}}
}
\def\dil@rightfoot{
  \rofoot{\texttt{\the\inputlineno}}
  \refoot{\texttt{\the\inputlineno}}
}
\fi

% Define commands for fancyhdr ...
\ifKV@dilfamily@fancyhdr
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\def\dil@insidehead{
  \fancyhead[RE,LO]{%
    \texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@outsidehead{
  \fancyhead[RO,LE]{%
    \texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@centerhead{
  \chead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@lefthead{
  \lhead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@righthead{
  \rhead{\texttt{\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@insidefoot{
  \fancyfoot[RE,LO]{\texttt{\the\inputlineno}}
}
\def\dil@outsidefoot{
  \fancyfoot[RO,LE]{\texttt{\the\inputlineno}}
}
\def\dil@centerfoot{
  \cfoot{\texttt{\the\inputlineno}}
}
\def\dil@leftfoot{
  \lfoot{\texttt{\the\inputlineno}}
}
\def\dil@rightfoot{
  \rfoot{\texttt{\the\inputlineno}}
}
\fi


%------------------------------
% Sections, environments
%------------------------------
\ifKV@dilfamily@sectionline
\pretocmd{\@startsection}{\addlineno}{}{}
\fi
\ifKV@dilfamily@captionline
\pretocmd{\caption}{\dilmnotefloat{\the\inputlineno}}{}{}
\fi
\ifKV@dilfamily@dilbasicenvlines
\setkeys{dilfamily}{environmentline={
    itemize,enumerate,description,quote,displaymath,equation,equation*,
    quotation,verse,abstract,flushleft,center,flushright,eqnarry,minipage
  }
}
\fi
\ifKV@dilfamily@dilamsmathenvlines
\setkeys{dilfamily}{environmentline={
    align,align*
  }}
\fi

\ifKV@dilfamily@dilinputfiles
\AtBeginOfInputs{%
  \ifKV@dilfamily@inputfilesrule%
  \noindent\rule{\linewidth}{1pt}\fi
  \dilmnote{Input file: \texttt{\currfilename} at line \texttt{\the\inputlineno}}
}
\AtBeginOfIncludes{\dilmnote{Include file: \texttt{\currfilename} at line \texttt{\the\inputlineno}}}
\AtEndOfInputs{%
  \ifKV@dilfamily@inputfilesrule%
  \noindent\rule{\linewidth}{1pt}\fi
  \dilmnote{End of \texttt{\currfilename}}}
\AtEndOfIncludes{\dilmnote{End of \texttt{\currfilename}}}
\fi


\AtBeginDocument{%
  \setcounter{firstline}{\the\inputlineno}%
}
