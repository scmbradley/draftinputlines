  %% draftinputlines.sty
  %% Copyright 2011 Seamus Bradley
  %
  % This work may be distributed and/or modified under the
  % conditions of the LaTeX Project Public License, either version 1.3
  % of this license or (at your option) any later version.
  % The latest version of this license is in
  %   http://www.latex-project.org/lppl.txt
  % and version 1.3 or later is part of all distributions of LaTeX
  % version 2005/12/01 or later.
  %
  % This work has the LPPL maintenance status `maintained'.
  % 
  % The Current Maintainer of this work is Seamus Bradley
  % tex@seamusbradley.net
  %
  % This work consists of the file draftinputlines.sty,
  % draftinputlines-man.tex and README;
  % and derived file draftinputlines-man.pdf

\ProvidesPackage{draftinputlines}[2011/08/11 v0.45]


%------------------------------
% Important packages
%------------------------------

\RequirePackage{currfile} % Loads filehook, which I also use...
\RequirePackage{etoolbox}
\RequirePackage{xkeyval}
\RequirePackage{marginnote}
\RequirePackage[excludeor]{everyhook}
%------------------------------
% New things
%------------------------------

\newcounter{firstline}

\newcommand\dilmnotefloat[1]{\notmarginhookfalse\marginnote{\raggedright\small #1}\notmarginhooktrue}
\let\dilmnote\dilmnotefloat
% I had two commands, but I decided I don't need the lines to float,
% and marginnote works inside floats...
%--------------------------------------------------
% Headers and footers
%--------------------------------------------------

\define@boolkeys{dilfamily}{scrpage,fancyhdr,memoir,plain}{}

%------------------------------
% Define some empty macros
%------------------------------
  \def\dil@insidehead{}
  \def\dil@outsidehead{}
  \def\dil@centerhead{}
  \def\dil@lefthead{}
  \def\dil@righthead{}
  \def\dil@offhead{}
  \def\dil@insidefoot{}
  \def\dil@outsidefoot{}
  \def\dil@centerfoot{}
  \def\dil@leftfoot{}
  \def\dil@rightfoot{}
  \def\dil@offfoot{}

%------------------------------
% Setup headers and footers
%------------------------------

\define@choicekey{dilfamily}{headfootpackage}{%
  scrpage,fancyhdr,memoir,plain}{%
  \setkeys{dilfamily}{#1=true}
}

%------------------------------
% The actual keys
%------------------------------

% Here is a terribly messy looking way of doing what I want:

% \define@choicekey{dilfamily}{inputlineshead}[\val\nr]{%
%   inside,outside,center,left,right,off}{%
%   \AtEndPreamble{
%     \ifcase\nr\relax
%     \dil@insidehead
%     \or
%     \dil@outsidehead
%     \or
%     \dil@centerhead
%     \or
%     \dil@lefthead
%     \or
%     \dil@righthead
%     \or
%     \relax
%     \fi
%   }
% }
% \define@choicekey{dilfamily}{inputlinesfoot}[\val\nr]{%
%   inside,outside,center,left,right,off}{%
%   \AtEndPreamble{
%     \ifcase\nr\relax
%     \dil@insidefoot
%     \or
%     \dil@outsidefoot
%     \or
%     \dil@centerfoot
%     \or
%     \dil@leftfoot
%     \or
%     \dil@rightfoot
%     \or
%     \relax
%     \fi
%   }
% }

% Here's a much neater way of doing it:

\define@choicekey{dilfamily}{inputlineshead}{%
  inside,outside,center,left,right,off}{%
  \AtEndPreamble{\csname dil@#1head\endcsname}%
}
\define@choicekey{dilfamily}{inputlinesfoot}{%
  inside,outside,center,left,right,off}{%
  \AtEndPreamble{\csname dil@#1foot\endcsname}%
}

\define@choicekey{dilfamily}{filenamehead}{%
  inside,outside,center,left,right,off}{%
  \AtEndPreamble{\csname dil@#1namehead\endcsname}%
}
\define@choicekey{dilfamily}{filenamefoot}{%
  inside,outside,center,left,right,off}{%
  \AtEndPreamble{\csname dil@#1namefoot\endcsname}%
}

%--------------------------------------------------
% Paragraph line numbers
%--------------------------------------------------

\newif\ifnotmarginhook
\notmarginhooktrue
\PushPostHook{par}{%
  \ifnotmarginhook%
  \notmarginhookfalse%
  {\marginnote{\small\ttfamily\the\inputlineno}}%
  \notmarginhooktrue%
  \fi%
}
%\newcommand\dil@nolineno[1]{\notmarginhookfalse #1\notmarginhooktrue}

%--------------------------------------------------
% Other input line numbers
%--------------------------------------------------
\def\dilfont{\ttfamily}
\define@cmdkey{dilfamily}{dilfont}{\def\dilfont{\cmdKV@dilfamily@dilfont}}

% Here comes the meat of the functionality
\newcommand\addlineno{\dilmnote{{\dilfont\the\inputlineno}}}


%%For posterity, here is the old way to have environments/sections and so on
%%dealt with individually
% \define@boolkeys{dilfamily}{sectionline,captionline}[true]{}

% \newcommand\dil@patchenv[1]{%
%   \AtBeginEnvironment{#1}{\addlineno}}
% \newcommand\dil@csvpatchenv{%
%   \let\do\dil@patchenv
%   \docsvlist}
% % Add environments to the list to have them print a line number.
% %\dil@csvpatchenv{itemize,enumerate,description,quote}


% \define@key{dilfamily}{environmentline}{\dil@csvpatchenv{#1}}
\define@boolkeys{dilfamily}{
  dilinputfiles,inputfilesrule,inputfloatname
}[true]{}
%   
% Optional lists of environments
% mathmode
% amsmath
% amsthm
% ntheorem's named envs?


%------------------------------
% Default options
%------------------------------


%--------------------------------------------------
% Here comes the options
%--------------------------------------------------

\ProcessOptionsX<dilfamily>

%------------------------------
% Headers and footers
%------------------------------
%------------------------------
% Define commands for scrpage
%------------------------------
\ifKV@dilfamily@scrpage
\RequirePackage{scrpage2}
\pagestyle{scrheadings}
\def\dil@insidehead{
  \ihead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@outsidehead{
\ohead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@centerhead{
  \chead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@lefthead{
  \lohead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
  \lehead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@righthead{
  \rohead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
  \rehead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@insidefoot{
  \ifoot{{\dilfont\the\inputlineno}}
}
\def\dil@outsidefoot{
  \ofoot{{\dilfont\the\inputlineno}}
}
\def\dil@centerfoot{
  \cfoot{{\dilfont\the\inputlineno}}
}
\def\dil@leftfoot{
  \lofoot{{\dilfont\the\inputlineno}}
  \lefoot{{\dilfont\the\inputlineno}}
}
\def\dil@rightfoot{
  \rofoot{{\dilfont\the\inputlineno}}
  \refoot{{\dilfont\the\inputlineno}}
}
\fi

%------------------------------
% Define commands for fancyhdr 
%------------------------------
\ifKV@dilfamily@fancyhdr
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\def\dil@insidehead{
  \fancyhead[RE,LO]{%
    {\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@outsidehead{
  \fancyhead[RO,LE]{%
    {\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@centerhead{
  \chead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@lefthead{
  \lhead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@righthead{
  \rhead{{\dilfont\arabic{firstline}}\setcounter{firstline}{\the\inputlineno}}
}
\def\dil@insidefoot{
  \fancyfoot[RE,LO]{{\dilfont\the\inputlineno}}
}
\def\dil@outsidefoot{
  \fancyfoot[RO,LE]{{\dilfont\the\inputlineno}}
}
\def\dil@centerfoot{
  \cfoot{{\dilfont\the\inputlineno}}
}
\def\dil@leftfoot{
  \lfoot{{\dilfont\the\inputlineno}}
}
\def\dil@rightfoot{
  \rfoot{{\dilfont\the\inputlineno}}
}
\fi


%------------------------------
% Sections, environments
%------------------------------

\ifKV@dilfamily@dilinputfiles
\AtBeginOfInputs{%
  \ifKV@dilfamily@inputfilesrule%
  \noindent\rule{\linewidth}{1pt}%
  \fi
  \@reversemargintrue
  \dilmnote{\dilfont\currfilename}
  \@reversemarginfalse
}

\AtEndOfInputs{%
  \ifKV@dilfamily@inputfilesrule%
  \noindent\rule{\linewidth}{1pt}%
  \fi%
  \@reversemargintrue%
  \dilmnote{\dilfont End \currfilename}%
  \@reversemarginfalse%
}
\AtBeginOfIncludes{\dilmnote{Include file: {\dilfont\currfilename} at line {\dilfont\the\inputlineno}}}
\AtEndOfIncludes{\dilmnote{End of {\dilfont\currfilename}}}
\fi

\AtBeginDocument{%
  \setcounter{firstline}{\the\inputlineno}%
}
